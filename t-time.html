<!DOCTYPE html>
<!-- Generated from t-time on ${generationDate} -->
<html lang="en-US"><head>
	<meta charset="UTF-8"/>
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,user-scalable=yes">
	<title>${title}</title>
	<link rel="stylesheet" href="t-time.css" />
</head><body>
<main role="main">
	<ul id="routeSelect">
${routeSelect}	</ul>
	<div id="routeDisplay">
${routeDisplay}	</div>
	<form id="dateForm" class="hide">
		<fieldset>
			<legend>Full schedule</legend>
			<input id="dateSelector" pattern="\d\d\d\d-\d\d-\d\d" type="date" placeholder="2016-12-24"/>
			<button type="submit">Show</button>
			<div id="staticSchedules"/>
		</fieldset>
	</form>
</main><script>
${javascript}
var _12hourClock=${_12hourClock};
var forEach=Array.prototype.forEach;
var referenceDate=null;
var updateTimerID=null;
document.addEventListener("DOMContentLoaded",function(){
	forEach.call(document.querySelectorAll("#routeSelect a"),function(e){
		e.addEventListener("click",function(e){
			e.preventDefault();
			hideAllRoutes();
			deleteAllChildren(document.getElementById("staticSchedules"));
			document.getElementById(this.dataset.route).classList.remove("hide");
			e.target.classList.add("selectedRoute");
			updateActiveSchedules();
		});
	});
	updateTimerID=window.setInterval(updateActiveSchedules,60000);
});
document.getElementById('dateForm').addEventListener("submit",function(e){
	e.preventDefault();
	var ds=document.getElementById('dateSelector');
	var selectedDate=ds.valueAsDate;
	if(null==selectedDate){
		selectedDate=new Date(new Date(ds.value).getTime()+(new Date().getTimezoneOffset()*60000));
	}
	updateStaticSchedules(selectedDate);
});
// will be called repeatedly to update times
function updateActiveSchedules(){
	var nowDate=new Date();
	resetSelector(nowDate);
	// new day, so update times
	if(referenceDate==null||nowDate.getDate()!=referenceDate.getDate()){
		setStopTimesForDay(nowDate);
		// unhide all tables
		forEach.call(document.getElementsByTagName("table"),function(table){
			table.classList.remove("hide");
			table.classList.remove("predicted");
		});
	}
	referenceDate=nowDate;
	var scheds=dates[prettyFormatDate(referenceDate)];
	var predictedSchedule=null==scheds;
	if(predictedSchedule){
		scheds=dates[referenceDate.getDay()];
	}
	var currentRouteTables=document.querySelectorAll("#routeDisplay>div:not(.hide)").item(0);
	if(null==currentRouteTables){
		return;
	}
	var route=routes[currentRouteTables.id];
	var newMillis=nowDate.getTime();
	forEach.call(currentRouteTables.querySelectorAll(".active"),function(table){
		var name=table.caption.innerText;
		if(predictedSchedule){
			table.classList.add("predicted");
		}
		var thead=deleteAllChildren(table.tHead);
		var tbody=deleteAllChildren(table.tBodies.item(0));
		var stopnames=route["stops"][name];
		var stoptimes={}
		forEach.call(stopnames,function(stopname){
			var headelement=document.createElement("th");
			headelement.innerText=stopname[0];
			headelement.dataset["stopid"]=stopname[1];
			thead.appendChild(headelement);
			stoptimes[stopname[0]]=[];
		});
		stopnames=getStopNames(stopnames);
		var timesExist=false;
		forEach.call(Object.keys(route["schedules"]),function(schedulename){
			if(-1<scheds.indexOf(schedulename)){
				forEach.call(route["schedules"][schedulename],function(trip){
					if(trip["direction"]==name){
						forEach.call(trip.stops,function(stop){
							var idx=stopnames.indexOf(stop["name"]);
							if(-1<idx){
								if(newMillis<stop["datetime"].getTime()){
									stoptimes[stop["name"]].push(stop["datetime"]);
									timesExist=true;
								}
							}
						});
						forEach.call(Object.keys(stoptimes),function(stopname){
							stoptimes[stopname].sort(function(a,b){
								if("string"==typeof(a)){
									return 1;
								}else if("string"==typeof(b)){
									return -1;
								}
								return a.getTime()-b.getTime();
							});
						});
					}
				});
			}
		});
		if(timesExist){
			forEach.call([0,1,2,3,4],function(rowcount){
				var row=tbody.insertRow();
				forEach.call(stopnames,function(stopname){
					var stoptime=stoptimes[stopname].shift();
					if(null==stoptime){
						stoptime="";
					}
					createTimeCell(stoptime,row);
				});
			});
		}else{
			// if there are no schedules for today, hide the table
			if(0==tbody.childNodes.length){
				table.classList.add("hide");
				forEach.call(table.parentNode.getElementsByClassName("active"),function(table){
					if(name==table.getElementsByTagName("caption").item(0).innerText){
						table.classList.add("hide");
					}
				});
			}
		}
	});
}
function updateStaticSchedules(forDate){
	referenceDate=forDate;
	var scheds=dates[prettyFormatDate(forDate)];
	var predictedSchedule=null==scheds;
	if(predictedSchedule){
		scheds=dates[forDate.getDay()];
	}
	setStopTimesForDay(forDate);
	var selectedRoute=document.querySelectorAll("#routeDisplay>div:not(.hide)").item(0).id;
	var route=routes[selectedRoute];
	var staticSchedules=deleteAllChildren(document.getElementById("staticSchedules"));
	forEach.call(Object.keys(route["stops"]),function(destination){
		var table=createTable(destination,predictedSchedule?["static","predicted"]:["static"]);
		staticSchedules.appendChild(table);
		forEach.call(Object.keys(route["schedules"]),function(schedulename){
			if(-1<scheds.indexOf(schedulename)){
				var name=table.caption.innerText;
				var thead=table.createTHead();
				var tbody=table.tBodies.item(0);
				var stopnames=route["stops"][name];
				forEach.call(stopnames,function(stopname){
					var headelement=document.createElement("th");
					headelement.innerText=stopname[0];
					headelement.dataset["stopid"]=stopname[1];
					thead.appendChild(headelement);
				});
				stopnames=getStopNames(stopnames);
				forEach.call(route["schedules"][schedulename],function(trip){
					if(trip["direction"]==name){
						var times=new Array(stopnames.length);
						times.fill("");
						forEach.call(trip.stops,function(stop){
							var idx=stopnames.indexOf(stop["name"]);
							if(-1<idx){
								times[idx]=stop.datetime;
							}
						});
						var row=tbody.insertRow();
						forEach.call(times,createTimeCell,row);
					}
				});
				if(0==tbody.childNodes.length){
					table.classList.add("hide");
					forEach.call(table.parentNode.getElementsByClassName("active"),function(table){
						if(name==table.getElementsByTagName("caption").item(0).innerText){
							table.classList.add("hide");
						}
					});
				}
			}
		});
	});
	referenceDate=null;
}
function dateExists(dateInArray){
	return this==dateInArray.getTime();
}
function resetSelector(dateObj){
	document.getElementById('dateForm').classList.remove("hide");
	var ds=document.getElementById('dateSelector');
	ds.placeholder=prettyFormatDate(dateObj);
	ds.value=prettyFormatDate(dateObj);
	if(ds.valueAsDate){
		ds.valueAsDate=dateObj;
	}
}
function hideAllRoutes(){
	forEach.call(document.querySelectorAll("#routeDisplay>div"),function(div){
		div.classList.add("hide");
	});
	forEach.call(document.querySelectorAll("#routeSelect a"),function(element){
		element.classList.remove("selectedRoute");
	});
}
function deleteAllChildren(element){
	while(element.firstChild){
		element.removeChild(element.firstChild);
	}
	return element;
}
function prettyFormatDate(forDate){
	return forDate.getFullYear()+"-"+(("00"+(forDate.getMonth()+1)).slice(-2))+"-"+("00"+forDate.getDate()).slice(-2);
}
function cloneDateWithTimeString(dateobj,timestr){
	var parts=timestr.split(":");
	return new Date(dateobj.getFullYear(),dateobj.getMonth(),dateobj.getDate(),new Number(parts[0]),new Number(parts[1]));
}
function getStopNames(stopnames){
	return stopnames.map(function(val){
		return val[0];
	});
}
function createTable(caption,classNames){
	var table=document.createElement("table");
	table.createCaption().innerText=caption;
	forEach.call(classNames,function(classname){table.classList.add(classname);});
	table.insertRow();
	table.deleteRow(-1);
	return table;
}
function setStopTimesForDay(theDay){
	forEach.call(Object.keys(routes),function(key){
		forEach.call(Object.keys(routes[key]["schedules"]),function(schedulename){
			forEach.call(routes[key]["schedules"][schedulename],function(trip){
				forEach.call(trip.stops,function(stop){
					stop.datetime=cloneDateWithTimeString(theDay,stop["time"]);
				});
			});
		});
	});
}
function createTimeCell(timeobj,altthis){
	var td=typeof(altthis)=="number"?this.insertCell():altthis.insertCell();
	if("object"==typeof(timeobj)){ // Date object
		td.classList.add("countdown"+Math.trunc((timeobj.getTime()-referenceDate.getTime())/60000));
		var hours=timeobj.getHours();
		if(_12hourClock){
			td.classList.add(hours>11?"pm":"am");
			if(hours>12){
				hours-=12;
			}
		}
		if(0==hours){
			hours=_12hourClock?12:24;
		}
		td.innerText=hours+":"+("00"+timeobj.getMinutes()).slice(-2);
	}
	return td;
}
</script></body></html>