<!DOCTYPE html>
<html lang="en-US"><head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,user-scalable=yes"/>
	<title>${title}</title>
	<meta name="application-name" content="${title} | t-time"/>
	<meta name="author" content="the Andrew Bailey"/>
	<meta name="generator" content="https://github.com/theandrewbailey/t-time"/>
	<meta name="description" content="time tables generated from a GTFS formatted feed"/>
	<meta http-equiv="Date" content="${generationDate}"/>
	<meta http-equiv="Last-Modified" content="${generationDate}"/>
	<link rel="stylesheet" href="t-time.css" />
</head><body>
<main>
${html}
	<form id="dateForm" class="hide">
		<fieldset>
			<label for="dateSelector">Full schedule</label>
			<input id="dateSelector" name="dateSelector" type="date" placeholder="2016-12-24" pattern="\d\d\d\d-\d\d-\d\d" />
			<button type="submit">Show</button>
		</fieldset>
		<section></section>
	</form>
</main><script>
${javascript}
var activeRows=5;
var forEach=Array.prototype.forEach;
var referenceDate=null;
var updateTimerID=null;
document.addEventListener("DOMContentLoaded",function(){
	"use strict";
	forEach.call(document.querySelectorAll("input[name=line]"),function(e){
		e.addEventListener("change",function(e){
			deleteAllChildren(document.querySelector("form>section"));
			updateActiveSchedules(e);
			resetSelector(referenceDate);
		});
	});
	if(updateActiveSchedules()){
		resetSelector(referenceDate);
	}
	updateTimerID=window.setInterval(updateActiveSchedules,60000);
});
document.getElementById('dateForm').addEventListener("submit",function(e){
	"use strict";
	e.preventDefault();
	var ds=document.getElementById('dateSelector');
	var dsv=new Date(ds.value);
	var selectedDate=new Date(dsv.getTime()+(dsv.getTimezoneOffset()*60000));
	updateStaticSchedules(selectedDate);
});
// will be called repeatedly to update times
function updateActiveSchedules(event){
	"use strict";
	var radiobutton=document.querySelector("input[name='line']:checked");
	if(null==radiobutton){return false;}
	var currentRouteTables=document.getElementById(radiobutton.value);
	if(null==currentRouteTables){return false;}
	var nowDate=new Date();
	if(null==referenceDate||nowDate.getDate()!=referenceDate.getDate()){
		// new day, so update times and unhide all tables
		setStopTimesForDay(nowDate);
		forEach.call(document.getElementsByTagName("table"),function(table){
			table.classList.remove("hide");
			table.classList.remove("predicted");
		});
	}
	referenceDate=nowDate;
	var scheds=dates[prettyFormatDate(referenceDate)];
	var predictedSchedule=null==scheds;
	if(predictedSchedule){
		scheds=dates[referenceDate.getDay()];
	}
	var route=routes[currentRouteTables.id];
	var newMillis=referenceDate.getTime();
	forEach.call(currentRouteTables.getElementsByTagName("table"),function(table){
		var name=table.caption.textContent;
		if(predictedSchedule){
			table.classList.add("predicted");
		}
		var thead=deleteAllChildren(table.tHead);
		var tbody=deleteAllChildren(table.tBodies.item(0));
		var stopnames=route["stops"][name];
		var stoptimes={}
		forEach.call(stopnames,function(stopname){
			var headelement=document.createElement("th");
			headelement.textContent=stopname[0];
			headelement.dataset["stopid"]=stopname[1];
			thead.appendChild(headelement);
			stoptimes[stopname[0]]=[];
		});
		stopnames=getStopNames(stopnames);
		var timesExist=false;
		forEach.call(Object.keys(route["schedules"]),function(schedulename){
			if(-1<scheds.indexOf(schedulename)&&name in route["schedules"][schedulename]){
				forEach.call(route["schedules"][schedulename][name],function(trip){
					forEach.call(trip,function(stopobj){
						if(null==stopobj){return;}
						var idx=stopnames.indexOf(stopobj["name"]);
						if(-1<idx){
							var sdt=stopobj["datetime"].getTime();
							var ssn=stoptimes[stopobj["name"]];
							if(newMillis<sdt&&-1==ssn.indexOf(sdt)){
								ssn.push(sdt);
								timesExist=true;
							}
						}
					});
					forEach.call(Object.keys(stoptimes),function(stopname){
						stoptimes[stopname].sort(function(a,b){
							return "string"==typeof(a)? 1: "string"==typeof(b)? -1: a-b;
						});
					});
				});
			}
		});
		if(timesExist){
			forEach.call(new Array(activeRows).fill(null),function(rowcount){
				var row=tbody.insertRow();
				forEach.call(stopnames,function(stopname){
					var stoptime=stoptimes[stopname].shift();
					createTimeCell(null==stoptime?"":stoptime,row);
				});
			});
		}else{
			// there are no schedules for today; hide the table
			if(0==tbody.childNodes.length){
				table.classList.add("hide");
			}
		}
	});
	return true;
}
function updateStaticSchedules(forDate){
	"use strict";
	referenceDate=forDate;
	var scheds=dates[prettyFormatDate(forDate)];
	var predictedSchedule=null==scheds;
	if(predictedSchedule){
		scheds=dates[forDate.getDay()];
	}
	setStopTimesForDay(forDate);
	var selectedRoute=document.querySelector("input[name='line']:checked").value;
	var route=routes[selectedRoute];
	var staticSchedules=deleteAllChildren(document.querySelector("form>section"));
	forEach.call(document.getElementById(selectedRoute).getElementsByTagName("table"),function(destinationtable){
		var destination=destinationtable.caption.textContent;
		var table=createTable(destination,predictedSchedule?["predicted"]:[]);
		var timesExist=false;
		forEach.call(Object.keys(route["schedules"]),function(schedulename){
			if(-1<scheds.indexOf(schedulename)&&destination in route["schedules"][schedulename]){
				var thead=table.createTHead();
				var tbody=table.tBodies.item(0);
				var stopnames=route["stops"][destination];
				forEach.call(stopnames,function(stopname){
					var headelement=document.createElement("th");
					headelement.textContent=stopname[0];
					headelement.dataset["stopid"]=stopname[1];
					thead.appendChild(headelement);
				});
				stopnames=getStopNames(stopnames);
				forEach.call(route["schedules"][schedulename][destination],function(trip){
					var times=new Array(stopnames.length);
					times.fill("");
					forEach.call(trip,function(stopobj){
						if(null==stopobj){return;}
						var idx=stopnames.indexOf(stopobj["name"]);
						if(-1<idx){
							times[idx]=stopobj.datetime.getTime();
						}
					});
					var row=tbody.insertRow();
					forEach.call(times,createTimeCell,row);
				});
				timesExist=timesExist||0!=tbody.childNodes.length;
			}
		});
		if(timesExist){
			staticSchedules.appendChild(table);
		}
	});
	referenceDate=null;
}
function resetSelector(dateObj){
	"use strict";
	document.getElementById('dateForm').classList.remove("hide");
	var ds=document.getElementById('dateSelector');
	ds.placeholder=prettyFormatDate(dateObj);
	ds.value=prettyFormatDate(dateObj);
}
function deleteAllChildren(element){
	"use strict";
	while(element.firstChild){
		element.removeChild(element.firstChild);
	}
	return element;
}
function prettyFormatDate(forDate){
	"use strict";
	return forDate.getFullYear()+"-"+(("00"+(forDate.getMonth()+1)).slice(-2))+"-"+("00"+forDate.getDate()).slice(-2);
}
function cloneDateWithTimeString(dateobj,timestr){
	"use strict";
	var parts=timestr.split(":");
	return new Date(dateobj.getFullYear(),dateobj.getMonth(),dateobj.getDate(),new Number(parts[0]),new Number(parts[1]));
}
function getStopNames(stopnames){
	"use strict";
	return stopnames.map(function(val){
		return val[0];
	});
}
function createTable(caption,classNames){
	"use strict";
	var table=document.createElement("table");
	table.createCaption().textContent=caption;
	forEach.call(classNames,function(classname){table.classList.add(classname);});
	table.insertRow();
	table.deleteRow(-1);
	return table;
}
function setStopTimesForDay(theDay){
	"use strict";
	forEach.call(Object.keys(routes),function(route){
		forEach.call(Object.keys(routes[route]["schedules"]),function(schedulename){
			forEach.call(Object.keys(routes[route]["schedules"][schedulename]),function(direction){
				forEach.call(routes[route]["schedules"][schedulename][direction],function(trip){
					forEach.call(trip,function(stopobj){
						if("string"==typeof(stopobj)){
							// initialize stop object
							var idx=trip.indexOf(stopobj);
							trip[idx]=new Stop(stopobj,cloneDateWithTimeString(theDay,stopobj),routes[route]["stops"][direction][idx][0]);
						}else if(null!=stopobj){
							stopobj.datetime=cloneDateWithTimeString(theDay,stopobj["time"]);
						}
					});
				});
			});
		});
	});
}
function Stop(time,datetime,stopname){
	this.time=time;
	this.datetime=datetime;
	this.name=stopname;
}
function createTimeCell(time,altthis){
	"use strict";
	var td=typeof(altthis)=="number"?this.insertCell():altthis.insertCell();
	if("number"==typeof(time)){ // Date millis
		var timeobj=new Date(time);
		td.classList.add("countdown"+Math.trunc((timeobj.getTime()-referenceDate.getTime())/60000));
		var hours=timeobj.getHours();
		if(_12hourClock){
			td.classList.add(hours>11?"pm":"am");
			if(hours>12){
				hours-=12;
			}
		}
		if(0==hours){
			hours=_12hourClock?12:24;
		}
		td.textContent=hours+":"+("00"+timeobj.getMinutes()).slice(-2);
	}
	return td;
}
</script></body></html>